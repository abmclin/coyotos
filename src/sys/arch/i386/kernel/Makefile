#
# Copyright (C) 2007, The EROS Group, LLC.
#
# This file is part of the Coyotos Operating System.
#
# This program is free software; you can redistribute it and/or
# modify it under the terms of the GNU General Public License
# as published by the Free Software Foundation; either version 2,
# or (at your option) any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with this program; if not, write to the Free Software
# Foundation, 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
#
default: package

CROSS_BUILD=yes

COYOTOS_SRC=../../../..
DIRS=

INC=-I../../../idl/BUILD -I../../.. -I. -I$(BUILDDIR)
DEF=-D__KERNEL__ # -DNDEBUG -DHAVE_HUI=0
DEF+= -DBRING_UP
DEF+= -DEVT_TRACE
DEF+= -include kerninc/annotations.h
#OPTIM+= -std=gnu99 -ffreestanding -O2 -g
OPTIM+= -std=gnu99 -ffreestanding -g
LINKOPTS= -g
OBJECTS=\
	$(BUILDDIR)/boot.o \
	$(BUILDDIR)/apboot.o \
	$(BUILDDIR)/interrupt.o \
	$(BUILDDIR)/GDT.o \
	$(BUILDDIR)/TSS.o \
	$(BUILDDIR)/IRQ.o \
	$(BUILDDIR)/PIC.o \
	$(BUILDDIR)/8259.o \
	$(BUILDDIR)/ioapic.o \
	$(BUILDDIR)/lapic.o \
	$(BUILDDIR)/PageFault.o \
	$(BUILDDIR)/HardClock.o \
	$(BUILDDIR)/init.o \
	$(BUILDDIR)/cpu.o \
	$(BUILDDIR)/cpuscan.o \
	$(BUILDDIR)/console.o \
	$(BUILDDIR)/vm.o \
	$(BUILDDIR)/dispatch.o \
	$(BUILDDIR)/acpi.o \
	$(BUILDDIR)/Object.o \
	$(BUILDDIR)/sysctl.o \
	$(BUILDDIR)/hwmap.o \
	$(BUILDDIR)/cap_Process.o \
	$(BUILDDIR)/transmap.o \
	$(BUILDDIR)/kern_main.o \
	$(BUILDDIR)/kern_ctype.o \
	$(BUILDDIR)/kern_string.o \
	$(BUILDDIR)/kern_pstring.o \
	$(BUILDDIR)/kern_printf.o \
	$(BUILDDIR)/kern_mutex.o \
	$(BUILDDIR)/kern_Depend.o \
	$(BUILDDIR)/kern_ObHash.o \
	$(BUILDDIR)/kern_PhysMem.o \
	$(BUILDDIR)/kern_Queue.o \
	$(BUILDDIR)/kern_Sched.o \
	$(BUILDDIR)/kern_EvtTrace.o \
	$(BUILDDIR)/kern_RevMap.o \
	$(BUILDDIR)/kern_CPU.o \
	$(BUILDDIR)/kern_Capability.o \
	$(BUILDDIR)/kern_MemWalk.o \
	$(BUILDDIR)/kern_Cache.o \
	$(BUILDDIR)/kern_Process.o \
	$(BUILDDIR)/kern_ObStore.o \
	$(BUILDDIR)/kern_Invoke.o \
	$(BUILDDIR)/kern_shellsort.o \
	$(BUILDDIR)/kern_Interval.o \
	$(BUILDDIR)/kern_IRQ.o \
	$(BUILDDIR)/kern_malloc.o \
	$(patsubst %.c,$(BUILDDIR)/%.o,$(notdir $(wildcard ../../../caps/cap*.c)))

VPATH=../../../kernel:../../../caps:.

include $(COYOTOS_SRC)/build/make/makerules.mk

all: $(BUILDDIR)/coyotos

install: $(BUILDDIR)/coyotos

$(BUILDDIR)/coyotos: $(OBJECTS) $(BUILDDIR)/ldscript
	$(GCC) -Wl,-T$(BUILDDIR)/ldscript  -nostdlib -o $@ $(OBJECTS) $(LINKOPTS) -lgcc
	$(SIZE) $@

$(BUILDDIR)/ldscript: ldscript.S target-hal/config.h $(MAKE_BUILDDIR)
	$(GCC) -E -P $(INC) $(DEF) $< > $@

$(BUILDDIR)/asm-offsets.s: asm-offsets.c $(MAKE_BUILDDIR)
	$(GCC) $(GCCFLAGS) $(GCCWARN) -S $< -o $@

$(BUILDDIR)/interrupt.o: $(BUILDDIR)/asm-offsets.h
$(BUILDDIR)/apboot.o: $(BUILDDIR)/asm-offsets.h

$(BUILDDIR)/asm-offsets.h: $(BUILDDIR)/asm-offsets.s
	@echo "/* This file is public domain." > $@
	@echo "   This file is automatically generated. Do not edit! */" >> $@
	@echo "#ifndef ARCH_ASM_OFFSETS_H" >> $@
	@echo "#define ARCH_ASM_OFFSETS_H" >> $@
	@echo "/** @file" >> $@
	@echo " * @brief Generated assembly offsets" >> $@
	@echo " */" >> $@
	@grep '#define' $< | sed 's/\$$//g' >> $@
	@echo "#endif /* ARCH_ASM_OFFSETS_H */" >> $@

MACH_HEADERS=\
	../../../coyotos/machine/target.h

$(OBJECTS) $(BUILDDIR)/ldscript $(BUILDDIR)/asm-offsets.s: $(MACH_HEADERS)
$(MACH_HEADERS): ../../../ARCH-LIST
	(cd ../../../coyotos/machine;make all)

-include $(BUILDDIR)/.*.m
